<style>
    .hidden {
        display:none;
    }
    .shown-section {
        cursor:pointer;
    }
    .shown-section:before {
        font-family: monospace!important;
        content:"\25BC\00a0";
    }
    .hidden-section {
        cursor:pointer;
    }
    .hidden-section:before {
        font-family: monospace!important;
        content:"\25B6\00a0";
    }
    table tr td {
        padding-right:4px;
    }
    textarea {
        resize:both!important;
    }
</style>
[% PROCESS settings/header.html %]

    [% WRAPPER settingSection %]

        <b style="font-size:125%" id="analyser-section-header" class="hidden-section" onclick="toggleSection('analyser-section', 'mixer-section')">[% "BLISSMIXER_ANALYSER" | string %]</b><br/><br/>
        <div id="analyser-section" class="hidden">
        [% IF server_auth || no_analyser_binary %]
          [% IF no_analyser_binary %]
          <div>[% "BLISSMIXER_ANALYSER_NOT_FOUND" | string %]</div><br/>
          [% ELSE %]
          <div>[% "BLISSMIXER_ANALYSER_AUTH_NOT_SUPPORTED" | string %]</div><br/>
          [% END %]
        [% ELSE %]

        <div style="opacity:0.6">[% "BLISSMIXER_ANALYSER_NOTE" | string %]</div><br/>

        [% WRAPPER settingGroup title="BLISSMIXER_ANALYSE_READ_TAGS" desc="BLISSMIXER_ANALYSE_READ_TAGS_DESC" %]
        <input type="checkbox" name="pref_analysis_read_tags" id="analysis_read_tags" [% IF prefs.analysis_read_tags %] checked [% END %] value="1"/>
        [% END %]
        [% WRAPPER settingGroup title="BLISSMIXER_ANALYSE_WRITE_TAGS" desc="BLISSMIXER_ANALYSE_WRITE_TAGS_DESC" %]
        <input type="checkbox" name="pref_analysis_write_tags" id="analysis_write_tags" [% IF prefs.analysis_write_tags %] checked [% END %] value="1"/>
        [% END %]
        [% WRAPPER settingGroup title="BLISSMIXER_RUN_AFTER_SCAN" desc="BLISSMIXER_RUN_AFTER_SCAN_DESC" %]
        <input type="checkbox" name="pref_run_analyser_after_scan" id="run_analyser_after_scan" [% IF prefs.run_analyser_after_scan %] checked [% END %] value="1"/>
        [% END %]
        [% WRAPPER settingGroup title="BLISSMIXER_ANALYSER_EXCLUDE_MEDIA_FOLDERS" desc="BLISSMIXER_ANALYSER_EXCLUDE_MEDIA_FOLDERS_DESC" %]
        <textarea class="stdedit" name="pref_analyser_ignore_dirs" id="analyser_ignore_dirs" cols="80" rows="3">[% prefs.analyser_ignore_dirs %]</textarea>
        [% END %]
        [% WRAPPER settingGroup title="BLISSMIXER_ANALYSER_IGNORE" desc="BLISSMIXER_ANALYSER_IGNORE_DESC" %]
        <textarea class="stdedit" name="pref_analyser_ignore_txt" id="analyser_analyser_ignore_txt" cols="80" rows="5">[% prefs.analyser_ignore_txt %]</textarea>
        [% END %]
        [% WRAPPER settingGroup title="BLISSMIXER_ANALYSER_MAX_FILES" desc="BLISSMIXER_ANALYSER_MAX_FILES_DESC" %]
        <input type="number" min="0" max="50000" class="stdedit" name="pref_analyser_max_files" id="analyser_max_files" value="[% prefs.analyser_max_files %]" size="5">
        [% END %]
        [% WRAPPER settingGroup title="BLISSMIXER_ANALYSER_MAX_THREADS" desc="BLISSMIXER_ANALYSER_MAX_THREADS_DESC" %]
        <input type="number" min="-4" max="256" class="stdedit" name="pref_analyser_max_threads" id="analyser_max_threads" value="[% prefs.analyser_max_threads %]" size="5">
        [% END %]
        <br/><hr style="opacity:0.4" class="sub-sep"/><br/>
        <div style="opacity:0.6">[% "BLISSMIXER_ANALYSIS_SETTINGS_NOTE" | string %]</div><br/>
        <button id="analyser" onclick="toggleBlissAnalyser()" type="button" style="margin-bottom:16px"></button>
        <button id="analyser-ignore" onclick="updateIgnore()" type="button" style="margin-left:8px;margin-bottom:16px">[% update_ignore_now_text %]</button>
        <div id="analyser-status" style="margin-top:8px"></div>
        [% END %]
        <br/><hr style="opacity:0.4" class="sub-sep"/><br/>
        </div>
        <b style="font-size:125%" id="mixer-section-header" class="shown-section" onclick="toggleSection('mixer-section', 'analyser-section')">[% "BLISSMIXER_MIX_SETTINGS" | string %]</b><br/><br/>
        <div id="mixer-section">
        <div style="opacity:0.6">[% "BLISSMIXER_MIX_SETTINGS_NOTE" | string %]</div><br/>

        [% WRAPPER settingGroup title="BLISSMIXER_NO_REPEAT_ARTIST" desc="BLISSMIXER_NO_REPEAT_ARTIST_DESC" %]
        <input type="number" min="0" max="200" class="stdedit" name="pref_no_repeat_artist" id="no_repeat_artist" value="[% prefs.no_repeat_artist %]" size="5">
        [% END %]

        [% WRAPPER settingGroup title="BLISSMIXER_NO_REPEAT_ALBUM" desc="BLISSMIXER_NO_REPEAT_ALBUM_DESC" %]
        <input type="number" min="0" max="200" class="stdedit" name="pref_no_repeat_album" id="no_repeat_album" value="[% prefs.no_repeat_album %]" size="5">
        [% END %]

        [% WRAPPER settingGroup title="BLISSMIXER_NO_REPEAT_TRACK" desc="BLISSMIXER_NO_REPEAT_TRACK_DESC" %]
        <input type="number" min="0" max="200" class="stdedit" name="pref_no_repeat_track" id="no_repeat_track" value="[% prefs.no_repeat_track %]" size="5">
        [% END %]

        [% WRAPPER settingGroup title="BLISSMIXER_MIN_DURATION" desc="BLISSMIXER_MIN_DURATION_DESC" %]
        <input type="number" min="0" max="3600" class="stdedit" name="pref_min_duration" id="min_duration" value="[% prefs.min_duration %]" size="5">
        [% END %]

        [% WRAPPER settingGroup title="BLISSMIXER_MAX_DURATION" desc="BLISSMIXER_MAX_DURATION_DESC" %]
        <input type="number" min="0" max="3600" class="stdedit" name="pref_max_duration" id="max_duration" value="[% prefs.max_duration %]" size="5">
        [% END %]

        [% WRAPPER settingGroup title="BLISSMIXER_MAX_BPM_DIFF" desc="BLISSMIXER_MAX_BPM_DIFF_DESC" %]
         <input type="number" min="0" max="200" class="stdedit" name="pref_max_bpm_diff" id="max_bpm_diff" value="[% prefs.max_bpm_diff %]" size="5">
        [% END %]

        [% WRAPPER settingGroup title="BLISSMIXER_NUM_DSTM_TRACKS" desc="BLISSMIXER_NUM_DSTM_TRACKS_DESC" %]
        <input type="number" min="2" max="20" class="stdedit" name="pref_dstm_tracks" id="dstm_tracks" value="[% prefs.dstm_tracks %]" size="5">
        [% END %]

        [% WRAPPER settingGroup title="BLISSMIXER_USE_FOREST" desc="BLISSMIXER_USE_FOREST_DESC" %]
        <input type="checkbox" name="pref_use_forest" id="use_forest" [% IF prefs.use_forest %] checked [% END %] value="1"/>
        [% END %]

        <br/><hr style="opacity:0.4" class="sub-sep"/><br/>
        <b style="font-size:120%">[% "GENRES" | string %]</b><br/><br/>
        <div style="opacity:0.6">[% "BLISSMIXER_GENRE_NOTE" | string %]</div><br/>

        [% WRAPPER settingGroup title="BLISSMIXER_FILTER_GENRES" desc="BLISSMIXER_FILTER_GENRES_DESC" %]
        <input type="checkbox" name="pref_filter_genres" id="filter_genres" [% IF prefs.filter_genres %] checked [% END %] value="1"/>
        [% END %]

        [% WRAPPER settingGroup title="BLISSMIXER_FILTER_XMAS" desc="BLISSMIXER_FILTER_XMAS_DESC" %]
        <input type="checkbox" name="pref_filter_xmas" id="filter_xmas" [% IF prefs.filter_xmas %] checked [% END %] value="1"/>
        [% END %]

        [% WRAPPER settingGroup title="BLISSMIXER_GENRE_GROUPS" desc="BLISSMIXER_GENRE_GROUPS_DESC" %]
        <textarea class="stdedit" name="pref_genre_groups" id="genre_groups" cols="80" rows="5">[% prefs.genre_groups %]</textarea>
        [% END %]

        [% WRAPPER settingGroup title="BLISSMIXER_USE_TRACK_GENRE" desc="BLISSMIXER_USE_TRACK_GENRE_DESC" %]
        <input type="checkbox" name="pref_use_track_genre" id="use_track_genre" [% IF prefs.use_track_genre %] checked [% END %] value="1"/>
        [% END %]

        [% IF server_auth %]
            <br/><hr style="opacity:0.4" class="sub-sep"/><br/>
            <div>[% "BLISSMIXER_PORT_NOTE" | string %]</div><br/>
            [% WRAPPER settingGroup title="BLISSMIXER_PORT" desc="BLISSMIXER_PORT_DESC" %]
            <input type="number" min="0" max="65535" class="stdedit" name="pref_mixer_port" id="mixer_port" value="[% prefs.mixer_port %]" size="5">
            [% END %]
        [% END %]


        <br/><hr style="opacity:0.4" class="sub-sep"/><br/>
        <b style="font-size:120%">[% "BLISSMIXER_METRICS" | string %]</b><br/><br/>
        <div style="opacity:0.6">[% "BLISSMIXER_METRICS_NOTE" | string %]</div><br/>

        [% WRAPPER settingGroup title="BLISSMIXER_METRIC_TEMPO" %]
        <input type="number" min="1" max="100" class="stdedit sliderInput_1_100_1" name="pref_weight_tempo" id="weight_tempo" value="[% prefs.weight_tempo %]" size="5">
        [% END %]
        [% WRAPPER settingGroup title="BLISSMIXER_METRIC_TIMBRE" %]
        <input type="number" min="1" max="100" class="stdedit sliderInput_1_100_1" name="pref_weight_timbre" id="weight_timbre" value="[% prefs.weight_timbre %]" size="5">
        [% END %]
        [% WRAPPER settingGroup title="BLISSMIXER_METRIC_LOUDNESS" %]
        <input type="number" min="1" max="100" class="stdedit sliderInput_1_100_1" name="pref_weight_loudness" id="weight_loudness" value="[% prefs.weight_loudness %]" size="5">
        [% END %]
        [% WRAPPER settingGroup title="BLISSMIXER_METRIC_CHROMA" %]
        <input type="number" min="1" max="100" class="stdedit sliderInput_1_100_1" name="pref_weight_chroma" id="weight_chroma" value="[% prefs.weight_chroma %]" size="5">
        [% END %]
        </div>
    [% END %]

[% PROCESS settings/footer.html %]

<script type="text/javascript">
    let statusInterval = undefined;
    let analyseButton = undefined;
    let ignoreButton = undefined;
    let analyseStatus = undefined;
    let analyserStatusMsgCount = 0;
    let intervalDuration = 1000;
    let analyserIsRunning = false;

    async function sendMsgToMixerPlugin(act) {
        const serverjsonurl = "[% jsonrpc_url %]";
        const msg = JSON.stringify({id: 1, method: 'slim.request', params: ['', ['blissmixer', 'analyser', 'act:'+act]]});
        let response = await fetch(serverjsonurl, {
            method: "post",
            headers: { "Content-Type": "application/json", "Origin": window.location.hostname },
            body: msg
        });
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return await response.json();
    }

    function toggleBlissAnalyser() {
        sendMsgToMixerPlugin('toggle').then((resp) => {
            getAnalyserStatus();
        });
    }

    function updateIgnore() {
        sendMsgToMixerPlugin('ignore').then((resp) => {
            getAnalyserStatus();
        });
    }

    function setHidden(elem, hidden) {
        let hasHidden = elem.className.split(' ').includes('hidden');
        if (hidden && !hasHidden) {
            elem.classList.add('hidden');
        } else if (!hidden && hasHidden) {
            elem.classList.remove('hidden');
        }
    }

    function getAnalyserStatus() {
        sendMsgToMixerPlugin('status').then((resp) => {
            analyserStatusMsgCount++;
            if (undefined!=resp && undefined!=resp.result) {
                analyserIsRunning = undefined!=resp.result.running && 1==parseInt(resp.result.running);
                if (undefined==analyseButton) {
                    analyseButton = document.getElementById('analyser');
                }
                if (undefined==ignoreButton) {
                    ignoreButton = document.getElementById('analyser-ignore');
                }
                if (undefined!=ignoreButton) {
                    setHidden(ignoreButton, analyserIsRunning);
                }
                if (undefined!=analyseButton) {
                    analyseButton.innerHTML = analyserIsRunning ? "[% stop_analysis_text %]" : "[% start_analysis_text %]";
                }
                if (undefined==analyseStatus) {
                    analyseStatus = document.getElementById('analyser-status');
                }
                if (undefined!=analyseStatus) {
                    let count = undefined!=resp.result.count ? parseInt(resp.result.count) : 0;
                    let analysed = "<tr><td>[% analysed_tracks_text %]</td><td>"+count+"</td></tr>";
                    let fcount = undefined!=resp.result.failed ? parseInt(resp.result.failed) : 0;
                    let failed = fcount > 0 ? "<tr><td>[% failed_tracks_text %]</td><td>"+fcount+"</td></tr>" : undefined;
                    let icount = undefined!=resp.result.ignored ? parseInt(resp.result.ignored) : 0;
                    let ignored = icount > 0 ? "<tr><td>[% ignored_tracks_text %]</td><td>"+icount+"</td></tr>" : undefined;
                    let status = analyserIsRunning && undefined!=resp.result.msg ? "<tr><td>[% analysis_status_text %]</td><td>"+resp.result.msg+"</td></tr>" : undefined;
                    let start = undefined;
                    let duration = undefined;

                    if (undefined!=resp.result.start) {
                        if (undefined!=resp.result.duration) {
                            let s = parseInt(resp.result.duration);
                            let dstr = [parseInt(s / 60 / 60), parseInt(s / 60 % 60), parseInt(s % 60)].join(':').replace(/\b(\d)\b/g, '0$1');
                            duration = "<tr><td>[% analysis_duration_text %]</td><td>"+dstr+"</td></tr>";
                        }
                        let date = new Date(parseInt(resp.result.start)*1000);
                        start = "<tr><td>[% analysis_start_text %]</td><td>"+date.toLocaleDateString()+" "+date.toLocaleTimeString()+"</td></tr>";
                    }
                    let msg = "<table>";
                    msg += analysed;
                    if (undefined!=failed) {
                        msg += failed;
                    }
                    if (undefined!=ignored) {
                        msg += ignored;
                    }
                    if (undefined!=start) {
                        msg += start;
                    }
                    if (undefined!=duration) {
                        msg += duration;
                    }
                    if (undefined!=status) {
                        msg += status;
                    }
                    msg += "</table>";
                    analyseStatus.innerHTML = msg;
                }
            }
            if (analyserIsRunning && intervalDuration>1000) {
                setAnalyserStatusInterval(1000);
            } else if (!analyserIsRunning && intervalDuration<5000 && analyserStatusMsgCount>5) {
                setAnalyserStatusInterval(5000);
            }
        });
    }

    function setAnalyserStatusInterval(v) {
        intervalDuration = v;
        clearInterval(statusInterval);
        statusInterval = setInterval(getAnalyserStatus, intervalDuration);
    }

    function toggleSection(id) {
        let elem = document.getElementById(id);
        if (undefined!=elem) {
            setSectionShown(id, elem.className.split(' ').includes("hidden"));
        }
    }

    function setSectionShown(id, show) {
        let elem = document.getElementById(id);
        let header = document.getElementById(id+"-header");
        if (undefined!=elem  && undefined!=header) {
            elem.classList.remove("hidden");
            header.classList.remove("shown-section");
            header.classList.remove("hidden-section");
            if (show) {
                header.classList.add("shown-section");
            } else {
                elem.classList.add("hidden");
                header.classList.add("hidden-section");
            }
            try {
                if (undefined!=window.localStorage) {
                    window.localStorage.setItem("bliss-mixer::"+id, show);
                }
            } catch (e)  { }
        }
    }

    window.addEventListener("load",() => {
        statusInterval = setInterval(getAnalyserStatus, 1000);
        getAnalyserStatus();
        try {
            if (undefined!=window.localStorage) {
                ["mixer-section", "analyser-section"].forEach(sect => {
                    let val = window.localStorage.getItem("bliss-mixer::"+sect);
                    setSectionShown(sect, undefined==val ? "mixer-section"==sect : "true"==val);
                });
            }
        } catch (e) {
        }
    });
</script>
